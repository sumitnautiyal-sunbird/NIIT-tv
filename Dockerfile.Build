#Dockerfile for the player setup
FROM node:8.11.0
#FROM node:10.16.0
MAINTAINER "Rajesh Rajendran <rajesh.r@optit.co>"
RUN sed -i '/jessie-updates/d' /etc/apt/sources.list
RUN apt-get update && apt-get install -y --no-install-recommends apt-utils \
&& apt-get install -y --force-yes \ 
 python python-dev autoconf g++ make nasm bzip2 
RUN mkdir -p /opt/player \
WORKDIR /opt/player
COPY * /opt/player/
WORKDIR /opt/player/app
RUN npm cache -f clean
RUN npm cache clean --force
#RUN rm -rf node_modules
RUN npm install -g @angular/cli@6
RUN npm set progress=false
RUN npm install  --unsafe-perm 
#RUN npm install --save-dev @angular-devkit/build-angular
#RUN npm i --only=dev
#RUN ng update
RUN npm update
#RUN ng update @angular/cli @angular/core
RUN npm run deploy
WORKDIR /opt/player/app/app_dist
RUN npm i -g npm@3.10.10
#RUN npm i npm@latest -g

RUN npm install --production  --unsafe-perm  
#RUN npm audit fix
WORKDIR /opt/player/app
# passing commit hash as build arg
ARG commit_hash=0
ENV commit_hash ${commit_hash}
CMD ["/bin/bash","-x","../vcs-config.sh"]   
